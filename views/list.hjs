<!DOCTYPE html>
<html>
<head>
    <script src="http://code.jquery.com/jquery.js" type="text/javascript"></script>
    <script src="http://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
    <script type="text/javascript">
        <!--
        var map;

        var coordinates = {};

        ymaps.ready(function () {
            map = new ymaps.Map("map", {
                center: [56.856702, 53.174075],
                zoom: 10
            });
            $.getJSON('/list/json', null, function (res) {
                var apartments = new ymaps.Clusterer();
                $.each(res, function (idx, itm) {
                    var desc = "<a target='blank' href='" + itm.url + "'>" + itm.id + "</a><br>" +
                            "District: " + itm.district + "<br>" +
                            "Address: " + itm.address + "<br>" +
                            "Rooms: " + itm.rooms + "<br>" +
                            "Area: " + itm.area + " m<sup>2</sup><br>" +
                            "Price: " + (itm.price / 1000) + " th. rubles<br>" +
                            "" + itm.createdAtStr + "<br>"
                    ymaps.geocode("Ижевск, " + itm.address)
                            .then(function (res) {
                                if (res.geoObjects && res.geoObjects.get(0)) {
                                    var obj = res.geoObjects.get(0);
                                    var p = new ymaps.GeoObject({
                                        geometry: obj.geometry,
                                        properties: {
                                            clusterCaption: itm.address,
                                            balloonContentBody: desc
                                        }
                                    });
                                    apartments.add(p);

                                    coordinates[itm.id] = p.geometry.getCoordinates();
                                }
                            },

                            function (err) {
                                console.error('Ошибка', err);
                            }
                    );
                });
                map.geoObjects.add(apartments);
            });
        });

        var positionOn = function (id) {
            var coord = coordinates[id];
            if (coord) {
                map.setCenter(coord, 17);
                $('#map').css('display', 'block');
            }
        };

        var star = function (id) {
            var el = $("#star_" + id);
            el.css('display', 'none');
            $.getJSON('/list/star?id=' + id, null, function (res) {
                el.html(res.starred ? 'X' : 'o');
                el.css('display', 'inline');
                $("#row_" + id).css('background', res.starred ? '#EEEEEE' : 'transparent');
            });
        }

        var filterStar = function () {
            if (location.href.indexOf('starred') < 0) {
                location.href = '/list/starred';
            } else {
                location.href = '/list';
            }
        }
        -->
    </script>
</head>
<body style="width: 100%; height: 100%">

<div style="position: fixed; right: 0; top: 0">
    <a href="JavaScript: return false;" onclick="filterStar()">Toggle star</a>
    <a href="JavaScript: return false;" onclick="$('#map').css('display', $('#map').css('display') == 'block' ? 'none' : 'block');">
        Show/Hide Map
    </a>


    <div id="map" style="display: none; position: absolute; width:900px; height:700px; right: 0"></div>
</div>

<div>
    <table border="1" cellpadding="10" cellspacing="0" style="margin-top: 80px">
        {{#apartments}}
        <tr id="row_{{id}}" {{#starred}}style="background: #EEEEEE"{{/starred}}>
            <td><a href="JavaScript: return false;" onclick="star('{{id}}')"
                   id="star_{{id}}">{{#starred}}X{{/starred}}{{^starred}}o{{/starred}}</a>
            </td>
            <td>
                <div style="display:block;width:50px; overflow: hidden">
                    <a target="_blank" href="{{url}}">{{id}}</a>
                </div>
            </td>
            <td><a href="JavaScript: return false;" onclick="positionOn('{{id}}')">on map</a></td>
            <td>{{district}}</td>
            <td>
                <div style="display:block;width:200px; overflow: hidden">{{address}}</div>
            </td>
            <td>{{rooms}}</td>
            <td>{{area}}</td>
            <td>{{price}}</td>
            <td>{{createdAtStr}}</td>
            <td style="padding: 0">
                <table>
                    {{#duplicates}}
                    <tr>
                        <td><a href="{{url}}">{{id}}</a></td>
                        <td>{{price}}</td>
                        <td>{{source}}</td>
                        <td>{{createdAtStr}}</td>
                    </tr>
                    {{/duplicates}}
                </table>
            </td>
        </tr>
        {{/apartments}}
    </table>
</div>
</body>
</html>